if ~periodic_boundary_simulation
    return;
end

if strcmp(periodic_boundary.mode,'TEM')
    Ex(1:nx,1,2:nz) = Cexe(1:nx,1,2:nz).*Ex(1:nx,1,2:nz) ...
        + Cexhz(1:nx,1,2:nz).*...
            (Hz(1:nx,1,2:nz)-Hz(1:nx,ny,2:nz)) ...
        + Cexhy(1:nx,1,2:nz).*...
            (Hy(1:nx,1,2:nz)-Hy(1:nx,1,1:nz-1));

    Ex(1:nx,nyp1,2:nz) = Ex(1:nx,1,2:nz);

    Ey(1,1:ny,2:nz) = Ceye(1,1:ny,2:nz).*Ey(1,1:ny,2:nz) ...
        + Ceyhx(1,1:ny,2:nz).*  ...
            (Hx(1,1:ny,2:nz)-Hx(1,1:ny,1:nz-1)) ...
        + Ceyhz(1,1:ny,2:nz).*  ...
            (Hz(1,1:ny,2:nz)-Hz(nx,1:ny,2:nz)); 

    Ey(nxp1,1:ny,2:nz) = Ey(1,1:ny,2:nz); 

    Ez(1,2:ny,1:nz) = Ceze(1,2:ny,1:nz).*Ez(1,2:ny,1:nz) ...
        + Cezhy(1,2:ny,1:nz).*  ...
            (Hy(1,2:ny,1:nz)-Hy(nx,2:ny,1:nz)) ...
        + Cezhx(1,2:ny,1:nz).*...
            (Hx(1,2:ny,1:nz)-Hx(1,1:ny-1,1:nz));

    Ez(nxp1,2:ny,1:nz) = Ez(1,2:ny,1:nz); ...

    Ez(2:nx,1,1:nz) = Ceze(2:nx,1,1:nz).*Ez(2:nx,1,1:nz) ...
        + Cezhy(2:nx,1,1:nz).*  ...
            (Hy(2:nx,1,1:nz)-Hy(1:nx-1,1,1:nz)) ...
        + Cezhx(2:nx,1,1:nz).*...
            (Hx(2:nx,1,1:nz)-Hx(2:nx,ny,1:nz));                  

    Ez(2:nx,nyp1,1:nz) = Ez(2:nx,1,1:nz);

    Ez(1,1,1:nz) = Ceze(1,1,1:nz).*Ez(1,1,1:nz) ...
        + Cezhy(1,1,1:nz).*  ...
            (Hy(1,1,1:nz)-Hy(nx,1,1:nz)) ...
        + Cezhx(1,1,1:nz).*...
            (Hx(1,1,1:nz)-Hx(1,ny,1:nz));

    Ez(nxp1,1,1:nz) = Ez(1,1,1:nz);

    Ez(1,nyp1,1:nz) = Ez(1,1,1:nz);

    Ez(nxp1,nyp1,1:nz) = Ez(1,1,1:nz);
end

if strcmp(periodic_boundary.mode,'TE') ...
        || strcmp(periodic_boundary.mode,'TM')

    kx = periodic_boundary.kx;
    ky = periodic_boundary.ky;
    Px = periodic_boundary.Px;
    Py = periodic_boundary.Py;

    Ex(1:nx,1,2:nz) = Cexe(1:nx,1,2:nz).*Ex(1:nx,1,2:nz) ...
        + Cexhz(1:nx,1,2:nz).*...
            (Hz(1:nx,1,2:nz)-Hz(1:nx,ny,2:nz)*exp(j*ky*Py)) ...
        + Cexhy(1:nx,1,2:nz).*...
            (Hy(1:nx,1,2:nz)-Hy(1:nx,1,1:nz-1));

    Ex(1:nx,nyp1,2:nz) = Ex(1:nx,1,2:nz)*exp(-j*ky*Py);

    Ey(1,1:ny,2:nz) = Ceye(1,1:ny,2:nz).*Ey(1,1:ny,2:nz) ...
        + Ceyhx(1,1:ny,2:nz).*  ...
            (Hx(1,1:ny,2:nz)-Hx(1,1:ny,1:nz-1)) ...
        + Ceyhz(1,1:ny,2:nz).*  ...
            (Hz(1,1:ny,2:nz)-Hz(nx,1:ny,2:nz)*exp(j*kx*Px)); 

    Ey(nxp1,1:ny,2:nz) = Ey(1,1:ny,2:nz)*exp(-j*kx*Px); 

    Ez(1,2:ny,1:nz) = Ceze(1,2:ny,1:nz).*Ez(1,2:ny,1:nz) ...
        + Cezhy(1,2:ny,1:nz).*  ...
            (Hy(1,2:ny,1:nz)-Hy(nx,2:ny,1:nz)*exp(j*kx*Px)) ...
        + Cezhx(1,2:ny,1:nz).*...
            (Hx(1,2:ny,1:nz)-Hx(1,1:ny-1,1:nz));

    Ez(nxp1,2:ny,1:nz) = Ez(1,2:ny,1:nz)*exp(-j*kx*Px); ...

    Ez(2:nx,1,1:nz) = Ceze(2:nx,1,1:nz).*Ez(2:nx,1,1:nz) ...
        + Cezhy(2:nx,1,1:nz).*  ...
            (Hy(2:nx,1,1:nz)-Hy(1:nx-1,1,1:nz)) ...
        + Cezhx(2:nx,1,1:nz).*...
            (Hx(2:nx,1,1:nz)-Hx(2:nx,ny,1:nz)*exp(j*ky*Py));                  

    Ez(2:nx,nyp1,1:nz) = Ez(2:nx,1,1:nz)*exp(-j*ky*Py);

    Ez(1,1,1:nz) = Ceze(1,1,1:nz).*Ez(1,1,1:nz) ...
        + Cezhy(1,1,1:nz).*  ...
            (Hy(1,1,1:nz)-Hy(nx,1,1:nz)*exp(j*kx*Px)) ...
        + Cezhx(1,1,1:nz).*...
            (Hx(1,1,1:nz)-Hx(1,ny,1:nz)*exp(j*ky*Py));

    Ez(nxp1,1,1:nz) = Ez(1,1,1:nz)*exp(-j*kx*Px);

    Ez(1,nyp1,1:nz) = Ez(1,1,1:nz)*exp(-j*ky*Py);

    Ez(nxp1,nyp1,1:nz) = Ez(1,1,1:nz)*exp(-j*kx*Px)*exp(-j*ky*Py);
end 